<!doctype html>
<html lang="fi">
<head>
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b0b0b">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script>
    if ("serviceWorker" in navigator){
        navigator.serviceWorker.register("service-worker.js");
    }
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Koodinkorjaaja – HTML editori</title>

    <style>
    html,body{
      margin:0; padding:0; height:100%;
      background:#0b0b0b; color:#eee; font-family:system-ui;
    }
    header{
      padding:14px; background:#111; border-bottom:1px solid #333;
      display:flex; gap:16px; flex-wrap:wrap; align-items:center;
    }
    button,label{
      background:#1e1e1e; border:1px solid #444; padding:10px 16px;
      border-radius:6px; cursor:pointer; color:#eee;
    }
    button:hover,label:hover{ background:#2a2a2a; }
    input[type=file]{ display:none; }

    #container{ width:100%; height:calc(100% - 100px); }
    #fallback{
      display:none;
      width:100%;
      height:calc(100% - 100px);
      background:#111;
      color:#eee;
      padding:12px;
      font-family:monospace;
      font-size:15px;
      border:none;
      outline:none;
    }
    </style>

    <!-- Toimiva Monaco CDN -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs/loader.js"></script>
</head>
<body>

<header>
  <label>
    <span>Lataa HTML-tiedosto</span>
    <input type="file" id="file" accept="text/html">
  </label>

  <button id="saveBtn">Tallenna muokattu tiedosto</button>
  <button id="formatBtn">Kaunista koodia</button>

  <!-- ✅ Uusi nappi: Tyhjennä kaikki -->
  <button id="clearBtn">Tyhjennä kaikki</button>

  <!-- ✅ Uusi nappi: Lisää tyhjennyskoodi kursorin kohdalle -->
  <button id="insertClearCodeBtn">Lisää tyhjennyskoodi</button>
</header>

<!-- Editorialue -->
<div id="container"></div>
<textarea id="fallback"></textarea>

<script>
let editor;
let currentFilename = "muokattu.html";

/* ---------------------------
   MONACO ALUSTUS + FALLBACK
----------------------------*/
require.config({
    paths: { "vs": "https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs" }
});

require(["vs/editor/editor.main"], function () {

    editor = monaco.editor.create(document.getElementById("container"), {
      value: "<!-- Lataa HTML-tiedosto nähdäksesi sisällön… -->",
      language: "html",
      theme: "vs-dark",
      automaticLayout: true,
      fontSize: 16,
      minimap: { enabled: false }
    });

}, function error() {

    document.getElementById("container").style.display = "none";
    const ta = document.getElementById("fallback");
    ta.style.display = "block";

    editor = {
      getValue: () => ta.value,
      setValue: v => ta.value = v
    };
});

/* ---------------------------
   LATAA TIEDOSTO
----------------------------*/
const fileInput = document.getElementById("file");
fileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;

  currentFilename = file.name;
  const reader = new FileReader();
  reader.onload = () => { editor.setValue(reader.result); };
  reader.readAsText(file);
});

/* ---------------------------
   TALLENNA TIEDOSTO
----------------------------*/
const saveBtn = document.getElementById("saveBtn");
saveBtn.addEventListener("click", () => {
  const text = editor.getValue();
  const blob = new Blob([text], { type:"text/html" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = currentFilename.replace(/\.html?$/, "") + "_muokattu.html";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* ---------------------------
   KAUNISTA KOODI
----------------------------*/
const formatBtn = document.getElementById("formatBtn");
formatBtn.addEventListener("click", () => {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(editor.getValue(), "text/html");
    const serialized = "<!doctype html>\n" +
      doc.documentElement.outerHTML.replace(/></g, ">\n<");

    editor.setValue(serialized);

  } catch(e) {
    alert("Muotoilu epäonnistui: " + e.message);
  }
});

/* ---------------------------
   ✅ TYHJENNÄ KAIKKI
----------------------------*/
document.getElementById("clearBtn").addEventListener("click", () => {
  editor.setValue("");
});

/* ---------------------------
   ✅ LISÄÄ TYYHJENNYSKOODI KURSORIN KOHTAAN
----------------------------*/
document.getElementById("insertClearCodeBtn").addEventListener("click", () => {

  const code = `
<!-- Tyhjennä kaikki nappi -->
<button id="clearBtn">Tyhjennä kaikki</button>
<script>
document.getElementById("clearBtn").addEventListener("click", () => {
  document.body.innerHTML = "";
});
</script>
`;

  const pos = editor.getPosition();
  editor.executeEdits("", [{
    range: new monaco.Range(pos.lineNumber, pos.column, pos.lineNumber, pos.column),
    text: code
  }]);
});
</script>

</body>
</html>
